# Epic 1 Retrospective - Backend Foundation & RBAC System

**Date:** 2026-02-02
**Epic:** Epic 1 - Backend Foundation & RBAC System
**Status:** ✅ COMPLETE (including role schema fix)
**Facilitator:** Bob (Scrum Master)
**Participants:** Alice (Product Owner), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev), V (Project Lead)

---

## UPDATE: Post-Retrospective Discovery

**CRITICAL UPDATE:** Setelah retrospektif ini dijalankan, ditemukan bahwa **role schema fix sudah selesai di-implementasikan** melalui workflow `quick-dev` dengan tech-spec `align-user-entity-minimal-epic-unblock.md`.

**Implementation Status:**
- ✅ Role entity + roles table created (15 production roles)
- ✅ User entity migrated: enum → FK pattern (roleId)
- ✅ JWT payload updated: role → roleId, estateId → plantationGroupId
- ✅ RolesGuard updated to check user.roleId
- ✅ Controllers updated with UPPERCASE role IDs (@Roles('KASIE_PG'))
- ✅ 191 tests passing
- ✅ Deployment: Railway → Supabase + Ngrok (working)

**Epic 1 is TRULY COMPLETE.** Epic 2-4 now unblocked.

---

## Epic Summary

### Delivery Metrics

| Metric | Value | Notes |
|--------|-------|-------|
| Stories Completed | 6/6 (100%) | All stories including role schema fix |
| Tests Passing | 191 | All unit tests passing |
| Code Review Issues Fixed | 18+ | Across all stories |
| Deployment | ✅ Working | Supabase + Ngrok |

### Stories Status

| Story | Title | Status | Key Notes |
|-------|-------|--------|-----------|
| 1.1 | Production Schema Discovery | ✅ Done | Found role_id FK pattern |
| 1.2 | Schedule Entity & CRUD | ✅ Done | 33 tests |
| 1.3 | Operators Module | ✅ Done | 15 tests |
| 1.4 | RBAC Roles Guard | ✅ Done | 12 guard tests |
| 1.5 | State Machine Validation | ✅ Done | CHECK constraint |
| 1.6 | Role Schema Fix | ✅ Done | Via quick-dev workflow |

---

## Deployment Journey

### Platform Evolution

| Stage | Platform | Status | Notes |
|-------|----------|--------|-------|
| 1 | Railway | ❌ Failed | Migration chaos, hard to reset DB |
| 2 | Docker Compose (local) | ✅ Working | PostgreSQL port 5433 |
| 3 | Supabase + Ngrok | ✅ Working | Staging environment |
| 4 | Production | ⏳ Future | TBD (Supabase prod or AWS RDS) |

### Current Architecture

| Component | Technology | Status |
|-----------|------------|--------|
| Database | Supabase (PostgreSQL) | ✅ Running |
| Backend | NestJS localhost:3000 | ✅ Working |
| Tunnel | Ngrok | ✅ Exposing to internet |
| CI/CD | GitHub Actions | ✅ Auto-build APK |

### Dev Test Accounts

| Username | Password | Role | Permission |
|----------|----------|------|------------|
| dev_kasie_pg | DevPassword123 | KASIE_PG | CREATE work plans |
| dev_kasie_fe | DevPassword123 | KASIE_FE | ASSIGN operators |
| dev_operator | DevPassword123 | OPERATOR | VIEW assigned only |

---

## Successes

### What Went Well

1. **Solid Schema Discovery (Story 1.1)**
   - Comprehensive production database inspection
   - Accurate entity mapping to production schema
   - Complete schema reference documentation

2. **Comprehensive Unit Testing**
   - 191 tests passing across all stories
   - Good coverage for CRUD operations
   - State machine validation well-tested

3. **Code Review Process**
   - 18+ issues identified and fixed
   - Iterative quality improvement
   - Senior developer review effective

4. **Role Schema Fix via Tech-Spec Workflow**
   - 12 tasks completed systematically
   - Database migrations executed successfully
   - All 15 production roles seeded
   - RBAC working with distinct KASIE_PG vs KASIE_FE

5. **Deployment Persistence**
   - Railway failed → Docker worked → Supabase stable
   - CORS issues identified and fixed
   - Mobile app now connecting successfully

---

## Challenges

### What Didn't Go Well

1. **Migration Chaos on Railway**
   - Orphaned migration (ALTER TABLE schedules before table existed)
   - Difficult to reset database state
   - Eventually abandoned Railway for Supabase

2. **CORS Configuration Issues**
   - Mobile app stuck loading due to CORS blocking
   - Required multiple fixes: headers, ngrok bypass, environment config
   - Root cause: NODE_ENV=staging treated as production-like

3. **Platform Hopping**
   - Railway → Docker → Supabase took time
   - Each platform had unique quirks
   - Eventually found stable setup

---

## Key Insights

### Lessons Learned

1. **Migration Safety Critical**
   - Never use `synchronize: true` in any environment
   - Always use explicit migrations
   - Test migrations on fresh database before deployment

2. **CORS is Often the Culprit**
   - Mobile + cloud deployment = CORS issues
   - Test early with actual device, not just curl
   - ngrok-skip-browser-warning header essential

3. **Supabase > Railway for This Use Case**
   - Easy database reset via dashboard
   - Migration visibility
   - Free permanent tier
   - IPv4 compatible (session pooler)

4. **Tech-Spec Workflow Effective**
   - 12 tasks systematically completed
   - Clear acceptance criteria
   - All tests updated

---

## Technical Decisions

### Schema Changes

| Before | After |
|--------|-------|
| id: UUID | id: INTEGER SERIAL |
| passwordHash | password |
| fullName | fullname |
| role: UserRole enum | roleId: string FK |
| estateId: UUID | plantationGroupId: string |

### JWT Payload

```typescript
// BEFORE
{ sub: 1, username: 'x', role: 'KASIE', estateId: 'uuid' }

// AFTER
{ sub: 1, username: 'x', roleId: 'KASIE_PG', plantationGroupId: 'PG001' }
```

### Deployment Config

```bash
# Staging environment
NODE_ENV=staging
DATABASE_URL=postgresql://postgres.[ref]:[pass]@pooler.supabase.com:5432/postgres
CORS_ORIGIN=*
```

---

## Files Changed Summary

**Created:**
- Role entity + module
- PlantationGroup entity + module
- 4 migrations (roles, plantation_groups, users, schedules)

**Modified:**
- User entity (enum → FK)
- Auth system (JWT, RolesGuard, decorators)
- Controllers (@Roles UPPERCASE)
- Seed service (3 dev users)
- 6 test files updated
- CI/CD workflow (auto-build APK)

**Deleted:**
- UserRole enum file

---

## Action Items

### Completed During Session

| # | Action | Owner | Status |
|---|--------|-------|--------|
| 1 | Create Role entity + module | Charlie | ✅ Done |
| 2 | Create PlantationGroup entity | Charlie | ✅ Done |
| 3 | Update User entity (enum → FK) | Charlie | ✅ Done |
| 4 | Update migrations | Charlie | ✅ Done |
| 5 | Update auth system | Charlie | ✅ Done |
| 6 | Update RolesGuard | Charlie | ✅ Done |
| 7 | Update controllers with @Roles | Charlie | ✅ Done |
| 8 | Update seed service | Charlie | ✅ Done |
| 9 | Update all tests | Charlie | ✅ Done |
| 10 | Migrate to Supabase | Charlie | ✅ Done |
| 11 | Fix CORS issues | Charlie | ✅ Done |
| 12 | Setup ngrok tunnel | Charlie | ✅ Done |
| 13 | CI/CD auto-build APK | Charlie | ✅ Done |

---

## Epic 2 Readiness

### Prerequisites Status

| Prerequisite | Status | Notes |
|--------------|--------|-------|
| Backend API | ✅ Ready | All endpoints working |
| RBAC Guards | ✅ Ready | KASIE_PG, KASIE_FE, OPERATOR distinguished |
| Dev Users | ✅ Ready | 3 users for testing |
| Database | ✅ Ready | Supabase stable |
| Mobile Connection | ✅ Ready | CORS fixed |
| CI/CD | ✅ Ready | Auto-build APK on push |

### Ready to Start

Epic 2 (Work Plan Creation) is **FULLY UNBLOCKED**:
- ✅ @Roles('KASIE_PG') works for CREATE permission
- ✅ @Roles('KASIE_FE') works for ASSIGN permission (Epic 3)
- ✅ Database schema aligned with production
- ✅ Backend deployed and accessible
- ✅ Mobile app can connect

---

## Next Steps

1. **Begin Epic 2: Work Plan Creation**
   - Story 2.1: Work Plan Feature Module Setup
   - Story 2.2: Create Work Plan Form UI
   - Story 2.3: Create Work Plan BLoC & Integration
   - Story 2.4: Work Plan List Display

2. **Test End-to-End Workflow**
   - Login as dev_kasie_pg → CREATE work plan
   - Login as dev_kasie_fe → ASSIGN operator
   - Login as dev_operator → VIEW assigned

3. **Future Deployment**
   - Consider Fly.io for permanent free deployment
   - Create Supabase production project when ready

---

## Team Feedback

### Alice (Product Owner)
- Epic 1 foundation solid, ready for Epic 2
- Role distinction now works perfectly
- Dev users enable real testing

### Charlie (Senior Dev)
- Migration refactoring was complex but necessary
- Supabase much better than Railway for this use case
- CORS was tricky but now understood

### Dana (QA Engineer)
- 191 tests passing gives confidence
- E2E testing needed for mobile-backend integration
- Dev accounts make testing easier

### Elena (Junior Dev)
- Learned about database migrations the hard way
- CORS debugging was educational
- Ready to support Epic 2 Flutter work

---

## Retrospective Closure

**Outcome:** ✅ EPIC 1 COMPLETE - All blockers resolved, Epic 2-4 unblocked.

**Key Achievement:** Role schema successfully aligned with production, enabling distinct KASIE_PG vs KASIE_FE permissions.

**Ready for:** Epic 2 implementation (Work Plan Creation).

---

*Document generated by BMAD Retrospective Workflow*
*Updated: 2026-02-02 after role schema fix completion*
